import streamlit as st
import pandas as pd
import numpy as np

# [ì„¤ì •] í˜ì´ì§€ ê¸°ë³¸ ì„¸íŒ…
st.set_page_config(page_title="Deep Agora: ìˆ™ì˜ì˜ ì •ì›", layout="wide", page_icon="ğŸŒ¿")

# --- 1. ê°€ìƒ ë°ì´í„° ìƒì„± (AIê°€ ì´ë¯¸ ì²˜ë¦¬í–ˆë‹¤ê³  ê°€ì •) ---
# ì‹¤ì œë¡œëŠ” LLMì´ ìˆ˜ì²œ ê°œì˜ ëŒ“ê¸€ì„ ë¶„ì„í•´ ì•„ë˜ì™€ ê°™ì€ DataFrameì„ ìƒì„±í•©ë‹ˆë‹¤.
def load_mock_data():
    data = {
        "user_id": ["User_A", "User_B", "User_C", "User_D", "User_E", "User_F", "User_G"],
        "original_text": [
            "ê¼°ëŒ€ë“¤ì´ ë­˜ ì•Œì•„? VPN ì“°ë©´ ë¨.", 
            "ì• ë“¤ ë§ì¹˜ëŠ” í‹±í†¡ ê¸ˆì§€ ì°¬ì„±!", 
            "ê¸°ìˆ ì ìœ¼ë¡œ ë§‰ëŠ” ê±´ ë¶ˆê°€ëŠ¥í•¨. êµìœ¡ì´ ì¤‘ìš”í•˜ì§€.", 
            "ì•Œê³ ë¦¬ì¦˜ ì¤‘ë… ì‹¬ê°í•¨. ê¸°ì—… ì±…ì„ ë¬¼ì–´ì•¼ í•¨.", 
            "ê°œì¸ì •ë³´ í„¸ì–´ê°€ë©´ì„œ ë‚˜ì´ í™•ì¸í•œë‹¤ê³ ? ë¯¸ì³¤ë„¤.", 
            "ë¶€ëª¨ê°€ ê´€ë¦¬í•´ì•¼ì§€ ì™œ êµ­ê°€ê°€ ë‚˜ì„œ?", 
            "ì²­ì†Œë…„ë„ ì‹œë¯¼ì¸ë° ê¸°ë³¸ê¶Œ ì¹¨í•´ì„."
        ],
        "refined_text": [ # AIê°€ 'í˜‘ë ¥ì (Collaborative)'ìœ¼ë¡œ ë³€í™˜í•œ í…ìŠ¤íŠ¸
            "ìš°íšŒ ê¸°ìˆ ì´ ë³´í¸í™”ëœ ìƒí™©ì—ì„œ ê°•ì œì  ì°¨ë‹¨ì€ ì‹¤íš¨ì„±ì´ ë‚®ë‹¤ëŠ” ìš°ë ¤ê°€ ìˆìŠµë‹ˆë‹¤.",
            "ì²­ì†Œë…„ ë³´í˜¸ë¥¼ ìœ„í•´ í”Œë«í¼ì˜ ìœ í•´í•œ ì˜í–¥ë ¥ì„ ê·œì œí•  í•„ìš”ì„±ì— ê¹Šì´ ê³µê°í•©ë‹ˆë‹¤.",
            "ê¸°ìˆ ì  ì°¨ë‹¨ë³´ë‹¤ëŠ” ë¯¸ë””ì–´ ë¦¬í„°ëŸ¬ì‹œ êµìœ¡ì´ ê·¼ë³¸ì ì¸ í•´ê²°ì±…ì´ ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.",
            "ì•Œê³ ë¦¬ì¦˜ì˜ ì¤‘ë…ì„± ë¬¸ì œëŠ” ì‹¬ê°í•˜ë©°, ì´ì— ëŒ€í•œ ê¸°ì—…ì˜ ì‚¬íšŒì  ì±…ì„ì„ ê°•í™”í•´ì•¼ í•©ë‹ˆë‹¤.",
            "ì—°ë ¹ ì¸ì¦ ê³¼ì •ì—ì„œ ë°œìƒí•  ìˆ˜ ìˆëŠ” ê³¼ë„í•œ ê°œì¸ì •ë³´ ìˆ˜ì§‘ê³¼ í”„ë¼ì´ë²„ì‹œ ì¹¨í•´ë¥¼ ìš°ë ¤í•©ë‹ˆë‹¤.",
            "êµ­ê°€ì˜ ì¼ê´„ì  ê·œì œë³´ë‹¤ëŠ” ê°€ì • ë‚´ì—ì„œì˜ ì§€ë„ì™€ ììœ¨ì„±ì´ ìš°ì„ ì‹œë˜ì–´ì•¼ í•œë‹¤ê³  ìƒê°í•©ë‹ˆë‹¤.",
            "ì²­ì†Œë…„ì˜ ë””ì§€í„¸ ì •ë³´ ì ‘ê·¼ê¶Œê³¼ ìê¸°ê²°ì •ê¶Œ ë˜í•œ ì¤‘ìš”í•œ ê°€ì¹˜ë¡œ ê³ ë ¤ë˜ì–´ì•¼ í•©ë‹ˆë‹¤."
        ],
        "topic_cluster": [ # AIê°€ ë¶„ë¥˜í•œ ì£¼ì œ (ìŠ¹íŒ¨ êµ¬ë„ê°€ ì•„ë‹Œ 'ìŸì ' ì¤‘ì‹¬)
            "ì‹¤íš¨ì„± ë° ê¸°ìˆ ", "ë³´í˜¸ ë° ê·œì œ í•„ìš”ì„±", "ì‹¤íš¨ì„± ë° ê¸°ìˆ ", "ë³´í˜¸ ë° ê·œì œ í•„ìš”ì„±", "í”„ë¼ì´ë²„ì‹œ/ê¸°ë³¸ê¶Œ", "í”„ë¼ì´ë²„ì‹œ/ê¸°ë³¸ê¶Œ", "í”„ë¼ì´ë²„ì‹œ/ê¸°ë³¸ê¶Œ"
        ],
        "civility_score": [0.2, 0.3, 0.85, 0.9, 0.4, 0.75, 0.8], # í’ˆê²© ì ìˆ˜ (ì›ë¬¸ ê¸°ì¤€)
        "representative_score": [0.5, 0.6, 0.95, 0.92, 0.7, 0.88, 0.85] # ëŒ€í‘œì„± ì ìˆ˜ (ë¹„ìŠ·í•œ ì˜ê²¬ì´ ì–¼ë§ˆë‚˜ ë§ì€ì§€ + ë…¼ë¦¬ì„±)
    }
    return pd.DataFrame(data)

df = load_mock_data()

# --- 2. UI: í—¤ë” ë° ì² í•™ ---
st.title("ğŸŒ¿ Deep Agora: ì˜ê²¬ ì •ì›")
st.markdown("""
> ì—¬ê¸°ëŠ” ì°¬ë°˜ì˜ ì „ìŸí„°ê°€ ì•„ë‹™ë‹ˆë‹¤.  
> ìˆ˜ë§ì€ ëª©ì†Œë¦¬ ì¤‘ **ê°€ì¥ ì„¤ë“ë ¥ ìˆê³  í’ˆê²© ìˆëŠ” ì˜ê²¬**ë“¤ì´ ëª¨ì—¬ ìˆ²ì„ ì´ë£¨ëŠ” ê³µê°„ì…ë‹ˆë‹¤.  
> *ê·¹ë‹¨ì ì¸ ë¹„ë‚œì€ ê±°ë¥´ê³ , ì„œë¡œì˜ í•µì‹¬ ê°€ì¹˜ë¥¼ ë“¤ì—¬ë‹¤ë´…ë‹ˆë‹¤.*
""")
st.divider()

# --- 3. í•µì‹¬ ê¸°ëŠ¥: 'ìŠ¹íŒ¨'ê°€ ì•„ë‹Œ 'ìŸì 'ë³„ ì¹´ë“œ ë³´ê¸° ---

# ì‚¬ì´ë“œë°”: í•„í„°ë§ ì˜µì…˜
with st.sidebar:
    st.header("ğŸ” ì •ì› ê°€ê¾¸ê¸°")
    st.caption("ë³´ê³  ì‹¶ì€ ì˜ê²¬ì˜ ê¸°ì¤€ì„ ì„¤ì •í•˜ì„¸ìš”.")
    min_quality = st.slider("í’ˆê²© í•„í„° (ìš•ì„¤/ë¹„ë‚œ ì œì™¸)", 0.0, 1.0, 0.4)
    st.info("ğŸ’¡ 'í’ˆê²© í•„í„°'ë¥¼ ë†’ì´ë©´ ê°ì •ì ì¸ ë°°ì„¤ì€ ì‚¬ë¼ì§€ê³  ë…¼ë¦¬ì ì¸ ì£¼ì¥ë§Œ ë‚¨ìŠµë‹ˆë‹¤.")

# ë©”ì¸ í™”ë©´: ì£¼ì œë³„ í´ëŸ¬ìŠ¤í„°ë§
# 3ê°œì˜ ì»¬ëŸ¼ìœ¼ë¡œ ë‚˜ëˆ„ì–´ 'ëŒ€ê²°'ì´ ì•„ë‹Œ 'ë³‘ë ¬' êµ¬ì¡°ë¡œ ë³´ì—¬ì¤Œ
col1, col2, col3 = st.columns(3)
topics = df["topic_cluster"].unique()

# ê° ì»¬ëŸ¼ì— ì£¼ì œ í•˜ë‚˜ì”© ë°°ì •
cols = [col1, col2, col3]

for i, topic in enumerate(topics):
    with cols[i]:
        st.subheader(f"ğŸ“Œ {topic}")
        
        # í•´ë‹¹ ì£¼ì œì˜ ë°ì´í„° í•„í„°ë§ & ì •ë ¬ (ì¤‘ìš”: ì¢‹ì•„ìš” ìˆœì´ ì•„ë‹ˆë¼ 'ëŒ€í‘œì„±/í’ˆê²©' ìˆœ)
        topic_df = df[
            (df["topic_cluster"] == topic) & 
            (df["civility_score"] >= min_quality)
        ].sort_values(by="representative_score", ascending=False)
        
        # ìƒìœ„ 2ê°œ ì˜ê²¬ë§Œ 'ì¹´ë“œ' í˜•íƒœë¡œ ë³´ì—¬ì¤Œ (Noise Reduction)
        for _, row in topic_df.head(2).iterrows():
            with st.container(border=True):
                # AIê°€ ì •ì œí•œ ë¬¸ì¥ì„ ë©”ì¸ìœ¼ë¡œ ë³´ì—¬ì¤Œ
                st.markdown(f"**ğŸ—£ï¸ {row['refined_text']}**")
                
                # ì‹œê°ì  ì§€í‘œ (ë”°ë´‰ ìˆ«ì ëŒ€ì‹  'ê³µê°ì˜ ê¹Šì´' í‘œí˜„)
                st.progress(row['representative_score'], text="ë…¼ë¦¬ì  ì™„ê²°ì„± ë° ëŒ€í‘œì„±")
                
                # íˆ¬ëª…ì„±: ì›ë¬¸ ë³´ê¸° (ì ‘ì–´ë‘ê¸°)
                with st.expander("ì›ë¬¸ í™•ì¸í•˜ê¸°"):
                    st.caption(f"ì‘ì„±ì ì˜ë„: {row['original_text']}")
                    if row['civility_score'] < 0.5:
                        st.warning("âš ï¸ ì›ë¬¸ì€ ë‹¤ì†Œ ê±°ì¹œ í‘œí˜„ì„ í¬í•¨í•˜ê³  ìˆì–´ AIê°€ ìˆœí™”í–ˆìŠµë‹ˆë‹¤.")

# --- 4. í•˜ë‹¨: ê³µí†µì˜ ê¸°ë°˜ (Bridge Building) ---
st.divider()
st.subheader("ğŸŒ‰ ìš°ë¦¬ê°€ ë§Œë‚˜ëŠ” ì§€ì  (Common Ground)")
st.markdown("""
ì„œë¡œ ë‹¤ë¥¸ ì£¼ì¥ì„ í•˜ê³  ìˆì§€ë§Œ, AI ë¶„ì„ ê²°ê³¼ ì°¸ì—¬ì **85%**ê°€ ì•„ë˜ ê°€ì¹˜ì—ëŠ” ë™ì˜í•˜ê³  ìˆìŠµë‹ˆë‹¤.
""")

# ë¸Œë¦¿ì§€ ë¦¬í¬íŠ¸ (ê°€ìƒ)
with st.container(border=True):
    st.markdown("### âœ… í•©ì˜ëœ ì›ì¹™")
    c1, c2 = st.columns(2)
    with c1:
        st.success("**1. ì²­ì†Œë…„ ë³´í˜¸ì˜ í•„ìš”ì„±**")
        st.caption("ì•Œê³ ë¦¬ì¦˜ì˜ ì¤‘ë…ì„±ìœ¼ë¡œë¶€í„° ì²­ì†Œë…„ì„ ë³´í˜¸í•´ì•¼ í•œë‹¤ëŠ” ëŒ€ì›ì¹™ì—ëŠ” ì´ê²¬ì´ ì—†ìŠµë‹ˆë‹¤.")
    with c2:
        st.success("**2. ì‹¤íš¨ì„± ìˆëŠ” ëŒ€ì•ˆ ìš”êµ¬**")
        st.caption("ë‹¨ìˆœ ì°¨ë‹¨ë³´ë‹¤ëŠ”, ìš°íšŒê°€ ë¶ˆê°€ëŠ¥í•˜ê±°ë‚˜ êµìœ¡ì´ ë³‘í–‰ë˜ëŠ” 'ì‹¤ì§ˆì  ëŒ€ì•ˆ'ì„ ì›í•©ë‹ˆë‹¤.")

# --- 5. ì°¸ì—¬ ìœ ë„: ë‚´ ì˜ê²¬ ì‹¬ê¸° ---
st.divider()
st.markdown("### ğŸŒ± ë‹¹ì‹ ì˜ ì˜ê²¬ ì‹¬ê¸°")
st.text_area("ì´ ì£¼ì œì— ëŒ€í•´ ë” ë³´íƒœê³  ì‹¶ì€ 'ê°€ì¹˜'ê°€ ìˆë‚˜ìš”?", placeholder="ë¹„ë‚œë³´ë‹¤ëŠ” ëŒ€ì•ˆì„, ê°ì •ë³´ë‹¤ëŠ” ë…¼ë¦¬ë¥¼ ë‹´ì•„ì£¼ì„¸ìš”.")
st.button("ì •ì›ì— ì˜ê²¬ ì‹¬ê¸°")